{
    admin off
}

:80 {
    # Main landing page
    @not_server {
        not path /server*
        not path /snapcast*
        not path /clients*
        not path /music*
        not path /grafana*
        not path /knx*
        not path /api*
        not path /swagger*
        not path /webui*
        not path /hubs*
    }

    handle @not_server {
        root * /srv
        file_server
        try_files {path} /index.html
    }

    # SnapDog WebUI - Frontend development server with hot reload (FIRST!)
    handle /webui* {
        reverse_proxy http://frontend:5173
    }

    # SignalR Hub - WebSocket support for real-time updates
    handle /hubs* {
        reverse_proxy http://app:5555 {
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }

    # SnapDog API
    handle /api* {
        reverse_proxy http://app:5555
    }

    # Swagger UI
    handle /swagger* {
        reverse_proxy http://app:5555
    }

    # Snapcast server - redirect /server to /server/ for proper relative paths
    @server_exact {
        path /server
        path_regexp server ^/server$
    }

    handle @server_exact {
        redir * /server/ 301
    }

    # Snapcast server with trailing slash - simple reverse proxy
    handle /server/* {
        uri strip_prefix /server
        reverse_proxy http://snapcast-server:1780
    }

    # WebSocket connections for control interface
    handle /snapcast* {
        uri strip_prefix /snapcast
        reverse_proxy http://snapcast-server:1705
    }

    # Navidrome music server
    handle /music* {
        reverse_proxy http://navidrome:4533
    }

    # Grafana Observability Dashboard
    handle /grafana/* {
        reverse_proxy http://grafana:3000
    }

    # KNX Monitor - Real-time KNX bus monitoring web interface
    handle /knx* {
        uri strip_prefix /knx
        reverse_proxy http://knx-monitor:8671
    }

    # Redirect for clients
    @client_living_room_exact {
        path /clients/living-room
        path_regexp client_lr ^/clients/living-room$
    }

    @client_kitchen_exact {
        path /clients/kitchen
        path_regexp client_k ^/clients/kitchen$
    }

    @client_bedroom_exact {
        path /clients/bedroom
        path_regexp client_b ^/clients/bedroom$
    }

    handle @client_living_room_exact {
        redir * /clients/living-room/ 301
    }

    handle @client_kitchen_exact {
        redir * /clients/kitchen/ 301
    }

    handle @client_bedroom_exact {
        redir * /clients/bedroom/ 301
    }

    # Clients with trailing slashes (mapped to our service names)
    handle /clients/living-room/* {
        uri strip_prefix /clients/living-room
        reverse_proxy http://snapcast-client-living-room:1780
    }

    handle /clients/kitchen/* {
        uri strip_prefix /clients/kitchen
        reverse_proxy http://snapcast-client-kitchen:1780
    }

    handle /clients/bedroom/* {
        uri strip_prefix /clients/bedroom
        reverse_proxy http://snapcast-client-bedroom:1780
    }

    log {
        output stdout
        format console
    }
}
