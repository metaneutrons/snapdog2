services:
  # SnapDog2 application - container-only development with full debugging
  app:
    build:
      context: .
      dockerfile: ./Dockerfile
      target: development # Multi-stage development target
    volumes:
      - .:/app:cached # Mount source code for hot reload
      - ~/.nuget/packages:/home/vscode/.nuget/packages:cached # NuGet cache
      - ~/.nuget/local:/app/local-nuget:cached # Local NuGet packages for development
      - snapcast_sinks:/snapsinks # Shared audio sinks with snapcast-server
    env_file:
      - ./devcontainer/.env
    environment:
      - DOTNET_ENVIRONMENT=Development
      - DOTNET_USE_POLLING_FILE_WATCHER=true
      - DOTNET_WATCH_RESTART_ON_RUDE_EDIT=true
    depends_on:
      - snapcast-server
      - mqtt
      - navidrome
      - signoz-otel-collector
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.2
    # Enable debugger
    stdin_open: true
    tty: true

  # Caddy reverse proxy with dashboard - SINGLE PORT TO HOST
  caddy:
    image: caddy:2-alpine
    ports:
      - "8000:80" # Only exposed port!
    volumes:
      - ./devcontainer/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./devcontainer/caddy/site:/srv:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - app
      - snapcast-server
      - snapcast-client-living-room
      - snapcast-client-kitchen
      - snapcast-client-bedroom
      - navidrome
      - signoz-frontend
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.4
    restart: unless-stopped

  # Snapcast Server - NO HOST PORTS
  snapcast-server:
    build:
      context: ./devcontainer/snapcast-server
    hostname: snapcast-server
    env_file:
      - ./devcontainer/.env
    ports:
      - "1705:1705" # Snapcast server port
    volumes:
      - snapcast_sinks:/snapsinks # Shared audio sinks with app container
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.5
    restart: unless-stopped

  # Living room client
  snapcast-client-living-room:
    build:
      context: ./devcontainer/snapcast-client
    restart: unless-stopped
    depends_on:
      - snapcast-server
    environment:
      - SNAPSERVER_HOST=172.25.0.5 # IP address of snapcast-server
      - CLIENT_ID=living-room
      - FIXED_MAC_ADDRESS=02:42:ac:11:00:10
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.6
        mac_address: 02:42:ac:11:00:10

  # Kitchen client
  snapcast-client-kitchen:
    build:
      context: ./devcontainer/snapcast-client
    restart: unless-stopped
    depends_on:
      - snapcast-server
    environment:
      - SNAPSERVER_HOST=172.25.0.5
      - CLIENT_ID=kitchen
      - FIXED_MAC_ADDRESS=02:42:ac:11:00:11
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.7
        mac_address: 02:42:ac:11:00:11

  # Bedroom client
  snapcast-client-bedroom:
    build:
      context: ./devcontainer/snapcast-client
    restart: unless-stopped
    depends_on:
      - snapcast-server
    environment:
      - SNAPSERVER_HOST=172.25.0.5
      - CLIENT_ID=bedroom
      - FIXED_MAC_ADDRESS=02:42:ac:11:00:12
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.8
        mac_address: 02:42:ac:11:00:12

  # MQTT Broker
  mqtt:
    image: eclipse-mosquitto:2.0
    volumes:
      - ./devcontainer/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./devcontainer/mosquitto/passwd:/mosquitto/config/passwd
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
    ports:
      - "1883:1883" # MQTT port
    environment:
      - MOSQUITTO_LOG_LEVEL=debug
    command: ["/usr/sbin/mosquitto", "-c", "/mosquitto/config/mosquitto.conf", "-v"]
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.3
    restart: unless-stopped

  # Navidrome - NO HOST PORTS (via Caddy)
  navidrome:
    image: deluan/navidrome:latest
    environment:
      ND_ENABLEINSIGHTSCOLLECTOR: "false" # Disable insights collector
      ND_SCANSCHEDULE: "1h"
      ND_LOGLEVEL: info
      ND_SESSIONTIMEOUT: "24h"
      ND_MUSICFOLDER: /music
      ND_DATAFOLDER: /data
      ND_BASEURL: "/music" # Configure for reverse proxy
    volumes:
      - ./devcontainer/music:/music:ro
      - navidrome_data:/data
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.9
    restart: unless-stopped

  # KNX Gateway Simulator - Custom Alpine-based container
  knxd:
    build:
      context: ./devcontainer/knxd
      dockerfile: Dockerfile
    environment:
      - ADDRESS=0.0.1 # KNX daemon address (standard format)
      - CLIENT_ADDRESS=0.0.2:8 # Client address range (start:count)
      - INTERFACE=dummy # Use dummy interface for simulation
      - DEBUG_LEVEL=verbose # Debug level (verbose for troubleshooting)
      - FILTERS=single,pace:queue # Filters with queue to avoid warnings
    ports:
      - "3671:3671/udp" # KNX/IP port
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.10
    restart: unless-stopped
    # Security: Run as non-root with minimal capabilities
    user: "1000:1000"
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    # Health check
    healthcheck:
      test: ["CMD", "netstat", "-ln"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ═══════════════════════════════════════════════════════════════════════════════
  # SigNoz Observability Stack
  # ═══════════════════════════════════════════════════════════════════════════════

  # ClickHouse Database for SigNoz
  signoz-clickhouse:
    image: clickhouse/clickhouse-server:23.7
    container_name: snapdog-signoz-clickhouse
    environment:
      - CLICKHOUSE_DB=signoz
      - CLICKHOUSE_USER=signoz
      - CLICKHOUSE_PASSWORD=signoz
    volumes:
      - signoz-clickhouse-data:/var/lib/clickhouse
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.20
    restart: unless-stopped

  # OpenTelemetry Collector for SigNoz
  signoz-otel-collector:
    image: signoz/signoz-otel-collector:0.88.11
    container_name: snapdog-signoz-otel-collector
    command: 
      - --config=/etc/otel-collector-config.yaml
    environment:
      - OTEL_RESOURCE_ATTRIBUTES=service.name=signoz-otel-collector,service.version=0.88.11
    volumes:
      - ./devcontainer/signoz/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC receiver
      - "4318:4318"   # OTLP HTTP receiver
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.21
    restart: unless-stopped
    depends_on:
      - signoz-clickhouse

  # SigNoz Query Service
  signoz-query-service:
    image: signoz/query-service:0.39.0
    container_name: snapdog-signoz-query-service
    environment:
      - ClickHouseUrl=tcp://signoz-clickhouse:9000/?database=signoz
      - STORAGE=clickhouse
      - GODEBUG=netdns=go
      - TELEMETRY_ENABLED=true
      - DEPLOYMENT_TYPE=docker-standalone
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.22
    restart: unless-stopped
    depends_on:
      - signoz-clickhouse
      - signoz-otel-collector

  # SigNoz Frontend
  signoz-frontend:
    image: signoz/frontend:0.39.0
    container_name: snapdog-signoz-frontend
    environment:
      - FRONTEND_API_ENDPOINT=http://signoz-query-service:8080
      - NEXT_PUBLIC_FRONTEND_API_ENDPOINT=http://localhost:8000/signoz-api
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.23
    restart: unless-stopped
    depends_on:
      - signoz-query-service

  # KNX Monitor - Visual debugging tool for KNX bus activity
  knx-monitor:
    image: ghcr.io/metaneutrons/knxmonitor:latest
    volumes:
      - ./devcontainer/knx-groupaddresses.csv:/app/knx-groupaddresses.csv:ro # KNX group addresses database
    environment:
      - TZ=Europe/Berlin # Set timezone for proper log timestamps
    command: ["-g", "knxd", "-v", "--csv", "/app/knx-groupaddresses.csv"]
    depends_on:
      knxd:
        condition: service_healthy
    networks:
      snapdog-dev:
        ipv4_address: 172.25.0.14
    stdin_open: true
    tty: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/ready"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "traefik.enable=false" # Not exposed via web interface
      - "com.docker.compose.service=knx-monitor"

volumes:
  mqtt_data:
  mqtt_logs:
  navidrome_data:
  caddy_data:
  caddy_config:
  snapcast_sinks: # Shared volume for audio sinks between snapcast-server and app
  signoz-clickhouse-data:
    name: snapdog-signoz-clickhouse-data

networks:
  snapdog-dev:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
