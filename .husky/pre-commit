#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

## SnapDog2 Pre-commit Hook
## Runs dotnet format and build only when code files are changed

# Check if any code files are being committed
code_files_changed=$(git diff --cached --name-only | grep -E '\.(cs|csproj|props|targets|sln|config|json)$')

if [ -n "$code_files_changed" ]; then
    echo '🎨 Code files detected. Checking formatting with dotnet format...'
    
    echo "❌ Code formatting issues found. Running formatter..."
    dotnet format --verbosity diagnostic
    format_fix_exit_code=$?

    if [ $format_fix_exit_code -eq 0 ]; then
        echo "✅ Code formatted successfully. Please review changes and commit again."
    else
        echo "❌ Failed to format code. Please check for syntax errors."
        exit 1
    fi

    echo "🏗️ Building project..."
    dotnet build --verbosity quiet

    if [ $? -ne 0 ]; then
        echo "❌ Build failed. Please fix errors before committing."
        exit 1
    fi

    # Optional: Uncomment to run tests on every commit (slower but safer)
    # echo "🧪 Running tests..."
    # dotnet test --verbosity quiet --no-build
    # if [ $? -ne 0 ]; then
    #     echo "❌ Tests failed. Please fix failing tests before committing."
    #     exit 1
    # fi

    echo "✅ Pre-commit checks passed!"
else
    echo "📝 Only documentation/config files changed. Skipping build checks."
fi
