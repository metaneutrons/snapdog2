#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

## SnapDog2 Pre-commit Hook
## Runs dotnet format and build before commit

echo 'ğŸ¨ Checking code formatting with dotnet format...'

# Check if code is properly formatted
dotnet format --verbosity diagnostic --verify-no-changes
format_exit_code=$?

if [ $format_exit_code -ne 0 ]; then
    echo "âŒ Code formatting issues found. Running formatter..."
    dotnet format --verbosity diagnostic
    format_fix_exit_code=$?
    
    if [ $format_fix_exit_code -eq 0 ]; then
        echo "âœ… Code formatted successfully. Please review changes and commit again."
    else
        echo "âŒ Failed to format code. Please check for syntax errors."
    fi
    exit 1
fi

echo "ğŸ—ï¸ Building project..."
dotnet build --verbosity quiet

if [ $? -ne 0 ]; then
    echo "âŒ Build failed. Please fix errors before committing."
    exit 1
fi

# Optional: Uncomment to run tests on every commit (slower but safer)
# echo "ğŸ§ª Running tests..."
# dotnet test --verbosity quiet --no-build
# if [ $? -ne 0 ]; then
#     echo "âŒ Tests failed. Please fix failing tests before committing."
#     exit 1
# fi

echo "âœ… Pre-commit checks passed!"
