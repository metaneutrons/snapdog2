#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

## SnapDog2 Pre-commit Hook
## Runs dotnet format and build before commit

echo '🎨 Checking code formatting with dotnet format...'

# Check if code is properly formatted
dotnet format --verbosity diagnostic --verify-no-changes
format_exit_code=$?

if [ $format_exit_code -ne 0 ]; then
    echo "❌ Code formatting issues found. Running formatter..."
    dotnet format --verbosity diagnostic
    format_fix_exit_code=$?
    
    if [ $format_fix_exit_code -eq 0 ]; then
        echo "✅ Code formatted successfully. Please review changes and commit again."
    else
        echo "❌ Failed to format code. Please check for syntax errors."
    fi
    exit 1
fi

echo "🏗️ Building project..."
dotnet build --verbosity quiet

if [ $? -ne 0 ]; then
    echo "❌ Build failed. Please fix errors before committing."
    exit 1
fi

# Optional: Uncomment to run tests on every commit (slower but safer)
# echo "🧪 Running tests..."
# dotnet test --verbosity quiet --no-build
# if [ $? -ne 0 ]; then
#     echo "❌ Tests failed. Please fix failing tests before committing."
#     exit 1
# fi

echo "✅ Pre-commit checks passed!"
